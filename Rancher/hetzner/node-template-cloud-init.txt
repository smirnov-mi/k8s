#cloud-config
#
# this is a could-config file
# for RKE k8s cluster built on Hetzner hardware/VMs
#
# 18.apr.2024 M.Smirnov 'rancher' version.

package_upgrade: true
package_reboot_if_required: true

runcmd:
# Fix Repo key
  - apt-key adv --recv-keys --keyserver keyserver.ubuntu.com AE33835F504A1A25
# Set packages on-hold (disable auto-upgrade)
#  - apt-mark hold kubectl kubelet kubeadm
#ADD ssh key
  - echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDCyQLzGaS4kUL068R8xe56HEED1sjZfByqqUDvYU65/ZPMiiakjMqrEWLY60ITt/QTM8s9y7vpjMgbADeiwGUEZHvlIpBC/Zq6c/CLFn2L3qJcITKS2Km+f3LwVxYQvRvNYJjAhOtnJ/CZiaoc5VWcG+mtjAfdKjnmpTyu4c6JYh9zYCgJOMfAcYMUbxgBQR81cjN9VaiHo9btff0Bd+S5MNzGB5KBFDXA6Pg6fDie8T7bNjcAbuOpm7ig777yxWtTpZW1qFCWNAXqbWSScBx5EdAhdhuGvH6mdi1Z+0V5gDM4IORDCBhbYbwED0XlwYh4npF1c6QUJa7xNEPqfD8HNnCQvjcafuWW0OmPPYiTUt2sP/6r8AKu+9Vt2xObVjO2u8E2jt+M+cTgDrL1Q6GTT/Gs8Iwp+/wmvarl/Dintd0I1hWl7kfL4o750Jvyeg9QIlPq7LSfN7pkbnr8ubLXolcv5yjXo7U6PpkmbsJ6goD69g4xJp2budIrAO21ZDe3vAtkvlOekQ3ZqYPg7WGw939HiLuho4fB/0RLNzT7mCJYox3hIQHybNRGAPhOouXsV2/OQ702lUBJweZqHksrCI6sKUXwX5q50tw2Dl8MhsW9PtwH87ZsvsFeJ1eLmxFvT811mb3exujUdYDYyQxIn/DJwDvenftcFnMy6UJM/w== ms" >> /root/.ssh/authorized_keys
  - echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC/Z3n6anl6cWpHGBB82BVab5mS/0Np47Ar3/Nf8ewN1g+0MkqJrDzXndlvpvlm0ZbH1pIh1kU/aYt3+hkpXBOl7XtKd3G0vE7HreqsbGjR0+MWijI1kpLHMG59EDq0zy93oBUJFv1T8xXI0Idypp5DLImKIFA0HSMUXW5/fbkl/1xlzerriS3L4Re2s5sP8iTIxce5u5vnMDiOeI6r9JY5KYQ+VnZHUX0wFNU8HWpCI6dUVN+mM3pffOdQKjEf/gkKvRU4cUY70u63x7SexKxUruo01rg+M1H6bESRqeB3jXOcjvtgCgUkojD5SeSQeI9qVPxl8+hmMcarp1SuaAXc6owQspdCi5Vv839ojsT7W74Z5jYqfJVy2TbBb3xvPZpNQQIa9EGGqzlH5SJmqWLpiDGWa5UCbVAczp4Gshx9jSM5Yuq5OQh81pBafo7jJOglrp4343oEjYujgQeyeZGv8tZcDQFHFAEKc1B3WsevkzBhJufBr/WGliuUK/0KwS0= ms" >> /root/.ssh/authorized_keys

#fixing 4 DNS entries:
  - sed -i "/- 2a01:4ff:ff00::add:2/d" /etc/netplan/50-cloud-init.yaml
  - chmod go-r /etc/netplan/50-cloud-init.yaml
  - netplan generate
  - netplan apply
  - systemctl restart systemd-resolved.service


## write .bash_aliases file
write_files:
#-   content: |
#      alias kuget='kubectl get --all-namespaces'
#      alias kugetw='kubectl get --all-namespaces -o wide'
#      alias k='kubectl'
#    owner: root:root
#    path: /root/.bash_aliases
#    permissions: '0644'

# write add. logrotate config
-   content: |
      /var/log/btmp
      {
       su root utmp
       create 660 root utmp
       rotate 14
       daily
       missingok
       notifempty
       compress
       delaycompress
       sharedscripts
       minsize 50M
       maxage 45
      }
    owner: root:root
    path: /etc/logrotate.d/maxcrc_k8s_host_ubuntu
    permissions: '0644'
packages:
- ntp
- ntpdate
# required if ceph will be used
- ceph-common
